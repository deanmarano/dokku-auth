#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

PLUGIN_BASE_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$PLUGIN_BASE_PATH/config"

# Only handle sso commands
[[ " sso:help sso " == *" $1 "* ]] || [[ "$1" == "sso:"* ]] || exit "${DOKKU_NOT_IMPLEMENTED_EXIT:-10}"

show_help() {
  cat << EOF
usage: dokku sso[:COMMAND]

Manage LDAP directory and SSO authentication for apps.

Example:

    $ dokku sso:list
      Directory services:
        production (lldap) - 3 apps
        staging (lldap) - 1 app

dokku sso directory commands:

    sso:create <service>                        create directory service
    sso:destroy <service> [-f|--force]          delete directory service
    sso:list                                    list all directory services
    sso:info <service>                          print service information
    sso:logs <service> [-t|--tail]              print container logs
    sso:status <service> [-q|--quiet]           show status (exit: 0=healthy, 2=down)
    sso:doctor <service>                        diagnose and fix issues

    sso:create-user <svc> <user> <email> <pass>  create a user in directory
    sso:link <service> <app>                    link app to directory service
    sso:unlink <service> <app>                  unlink app from directory
    sso:sync <service>                          sync default group to app groups
    sso:credentials <service>                   show LDAP bind credentials

    sso:protect <app>                           add SSO protection (auto-detect frontend)
    sso:unprotect <app>                         remove SSO protection

    sso:provider:set <service> <provider>       set directory provider
    sso:provider:config <service> KEY=value     configure provider settings
    sso:provider:apply <service>                apply configuration changes
    sso:providers                               list available providers

dokku sso:frontend commands:

    sso:frontend:create <service>               create frontend service
    sso:frontend:destroy <service> [-f|--force] delete frontend service
    sso:frontend:list                           list all frontend services
    sso:frontend:info <service>                 print frontend information
    sso:frontend:status <service>               show status (exit: 0=up, 1=down)
    sso:frontend:logs <service> [-t|--tail]     print container logs

    sso:frontend:use-directory <svc> <dir-svc>  link frontend to directory
    sso:frontend:protect <service> <app>        add SSO protection to app
    sso:frontend:unprotect <service> <app>      remove SSO protection
    sso:frontend:refresh <service>              re-apply protection to all linked apps

    sso:frontend:provider:set <service> <prov>  set frontend provider
    sso:frontend:provider:config <svc> KEY=val  configure provider settings
    sso:frontend:provider:apply <service>       apply configuration changes

dokku sso:oidc commands:

    sso:oidc:enable <service>                   enable OIDC on frontend
    sso:oidc:disable <service>                  disable OIDC on frontend
    sso:oidc:add-client <svc> <id> [secret] [uri]  register OIDC client
    sso:oidc:remove-client <service> <id>       remove OIDC client
    sso:oidc:list <service>                     list registered clients

Directory providers: lldap (default), glauth, openldap, kanidm
Frontend providers:  authelia (default), authentik, vouch
EOF
}

case "$1" in
  sso|sso:help)
    show_help
    ;;
  sso:*)
    subcommand="${1#sso:}"
    shift

    # Map subcommands to files (handle nested commands like frontend:create)
    # Convert colons and hyphens to underscores
    normalized_subcommand="${subcommand//:/_}"
    normalized_subcommand="${normalized_subcommand//-/_}"
    subcommand_file="$PLUGIN_BASE_PATH/subcommands/$normalized_subcommand"

    if [[ -x "$subcommand_file" ]]; then
      exec "$subcommand_file" "$@"
    else
      echo "Unknown command: sso:$subcommand" >&2
      echo "Run 'dokku sso:help' for usage" >&2
      exit 1
    fi
    ;;
  *)
    exit "${DOKKU_NOT_IMPLEMENTED_EXIT:-10}"
    ;;
esac
