#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

source "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/config"
source "$PLUGIN_BASE_PATH/providers/loader.sh"

# Strip command prefix if dokku passed it
[[ "${1:-}" == sso:* ]] && shift


SERVICE=""
FORCE=""
KEEP_APP=""

for arg in "$@"; do
  case "$arg" in
    -f|--force)
      FORCE="true"
      ;;
    --keep-app)
      KEEP_APP="true"
      ;;
    *)
      [[ -z "$SERVICE" ]] && SERVICE="$arg"
      ;;
  esac
done

if [[ -z "$SERVICE" ]]; then
  echo "Usage: dokku sso:frontend:destroy <service> [-f|--force] [--keep-app]" >&2
  echo "" >&2
  echo "Options:" >&2
  echo "  -f, --force  Skip confirmation prompt" >&2
  echo "  --keep-app   Unregister without destroying the Dokku app" >&2
  exit 1
fi

SERVICE_ROOT="$PLUGIN_DATA_ROOT/frontend/$SERVICE"

if ! frontend_service_exists "$SERVICE"; then
  echo "!     Service $SERVICE does not exist" >&2
  exit 1
fi

# Check for protected apps
if [[ -s "$SERVICE_ROOT/PROTECTED" ]] && [[ -z "$FORCE" ]]; then
  echo "!     Service has protected apps:" >&2
  while IFS= read -r app; do
    echo "       - $app" >&2
  done < "$SERVICE_ROOT/PROTECTED"
  echo "" >&2
  echo "       Use -f to force destroy" >&2
  exit 1
fi

if [[ -z "$FORCE" ]]; then
  echo "!     WARNING: This will destroy all data for $SERVICE"
  echo -n "       Type 'yes' to confirm: "
  read -r CONFIRM
  if [[ "$CONFIRM" != "yes" ]]; then
    echo "       Aborted"
    exit 1
  fi
fi

echo "-----> Destroying frontend service $SERVICE"

# Unprotect all apps first
if [[ -s "$SERVICE_ROOT/PROTECTED" ]]; then
  echo "       Unprotecting apps..."
  load_frontend_provider "$SERVICE"
  while IFS= read -r app; do
    [[ -z "$app" ]] && continue
    echo "       - $app"
    provider_unprotect_app "$SERVICE" "$app" 2>/dev/null || true
  done < "$SERVICE_ROOT/PROTECTED"
fi

# Destroy the backing app/container (unless --keep-app)
load_frontend_provider "$SERVICE"
if [[ -n "$KEEP_APP" ]]; then
  APP_NAME=$(get_frontend_app_name "$SERVICE")
  if [[ -n "$APP_NAME" ]]; then
    echo "       Keeping Dokku app $APP_NAME"
  fi
else
  provider_destroy "$SERVICE"
fi

# Remove service directory
if [[ -d "$SERVICE_ROOT" ]]; then
  rm -rf "$SERVICE_ROOT" 2>/dev/null || true
  if [[ -d "$SERVICE_ROOT" ]]; then
    echo "!     Warning: Could not fully remove $SERVICE_ROOT" >&2
    echo "       You may need to remove it manually with: sudo rm -rf $SERVICE_ROOT" >&2
  fi
fi

echo "-----> Service $SERVICE destroyed"
