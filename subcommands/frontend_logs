#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

source "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/config"
source "$PLUGIN_BASE_PATH/providers/loader.sh"

# Strip command prefix if dokku passed it
[[ "${1:-}" == sso:* ]] && shift


SERVICE="$1"
shift || true  # Remove service name from args

if [[ -z "$SERVICE" ]]; then
  echo "Usage: dokku sso:frontend:logs <service> [options]" >&2
  echo "" >&2
  echo "Options:" >&2
  echo "  --tail NUM   Number of lines to show" >&2
  echo "  -f, --follow Follow log output" >&2
  exit 1
fi

if ! frontend_service_exists "$SERVICE"; then
  echo "!     Service $SERVICE does not exist" >&2
  exit 1
fi

# Convert common options to dokku logs format
LOGS_ARGS=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    -n|--tail)
      LOGS_ARGS+=(--num "$2")
      shift 2
      ;;
    -t|--follow|-f)
      LOGS_ARGS+=(--tail)
      shift
      ;;
    *)
      LOGS_ARGS+=("$1")
      shift
      ;;
  esac
done

load_frontend_provider "$SERVICE"

provider_logs "$SERVICE" "${LOGS_ARGS[@]}"
