#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

source "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/config"
source "$PLUGIN_BASE_PATH/providers/loader.sh"

# Strip command prefix if dokku passed it
[[ "${1:-}" == sso:* ]] && shift

# Parse arguments
SERVICE=""
PROVIDER=""
ADOPT_APP=""
DIRECTORY=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    --provider)
      PROVIDER="$2"
      shift 2
      ;;
    --provider=*)
      PROVIDER="${1#*=}"
      shift
      ;;
    --app)
      ADOPT_APP="$2"
      shift 2
      ;;
    --app=*)
      ADOPT_APP="${1#*=}"
      shift
      ;;
    --directory)
      DIRECTORY="$2"
      shift 2
      ;;
    --directory=*)
      DIRECTORY="${1#*=}"
      shift
      ;;
    -*)
      echo "!     Unknown option: $1" >&2
      exit 1
      ;;
    *)
      SERVICE="$1"
      shift
      ;;
  esac
done

if [[ -z "$SERVICE" ]]; then
  echo "Usage: dokku sso:frontend:create <service> [--provider <provider>] [--app <dokku-app>]" >&2
  echo "" >&2
  echo "Create a new frontend SSO service" >&2
  echo "" >&2
  echo "Options:" >&2
  echo "  --provider <provider>  Frontend provider to use (default: $DEFAULT_FRONTEND_PROVIDER)" >&2
  echo "                         Available: $(list_frontend_providers | tr '\n' ' ')" >&2
  echo "  --app <dokku-app>      Adopt an existing Dokku app instead of creating a new one" >&2
  exit 1
fi

# Use default provider if not specified
if [[ -z "$PROVIDER" ]]; then
  PROVIDER="$DEFAULT_FRONTEND_PROVIDER"
fi

# Validate provider exists
if [[ ! -f "$PLUGIN_BASE_PATH/providers/frontend/$PROVIDER/provider.sh" ]]; then
  echo "!     Unknown provider: $PROVIDER" >&2
  echo "       Available providers: $(list_frontend_providers | tr '\n' ' ')" >&2
  exit 1
fi

# Validate service name
if [[ ! "$SERVICE" =~ ^[a-z][a-z0-9-]*$ ]]; then
  echo "!     Service name must start with a letter and contain only lowercase letters, numbers, and hyphens" >&2
  exit 1
fi

SERVICE_ROOT="$PLUGIN_DATA_ROOT/frontend/$SERVICE"

if frontend_service_exists "$SERVICE" && [[ -z "$ADOPT_APP" ]]; then
  echo "!     Service $SERVICE already exists" >&2
  exit 1
fi

echo "-----> Creating frontend SSO service $SERVICE (provider: $PROVIDER)"

# Create service directory (idempotent for adopt case)
mkdir -p "$SERVICE_ROOT/config" "$SERVICE_ROOT/data"
echo "$PROVIDER" > "$SERVICE_ROOT/PROVIDER"

# Link directory service if specified (before provider load so config includes LDAP)
if [[ -n "$DIRECTORY" ]]; then
  if ! directory_service_exists "$DIRECTORY"; then
    echo "!     Directory service $DIRECTORY does not exist" >&2
    exit 1
  fi
  echo "$DIRECTORY" > "$SERVICE_ROOT/DIRECTORY"
  echo "-----> Linking to directory service $DIRECTORY"
fi

# Load provider
load_frontend_provider "$SERVICE"

if [[ -n "$ADOPT_APP" ]]; then
  # Adopt an existing Dokku app
  echo "-----> Adopting existing Dokku app $ADOPT_APP"
  provider_adopt_app "$SERVICE" "$ADOPT_APP"
else
  # Deploy a new Dokku app
  provider_create_container "$SERVICE"
fi

echo "-----> Frontend service $SERVICE created"
echo ""
if [[ -n "$ADOPT_APP" ]]; then
  echo "       Next steps:"
  echo "       1. Protect an app: dokku sso:frontend:protect $SERVICE <app>"
else
  echo "       Next steps:"
  echo "       1. Configure domain: dokku sso:frontend:config $SERVICE DOMAIN=auth.example.com"
  echo "       2. Link to directory: dokku sso:frontend:use-directory $SERVICE <directory-service>"
  echo "       3. Apply config:      dokku sso:frontend:apply $SERVICE"
fi
