#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

source "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/config"
source "$PLUGIN_BASE_PATH/providers/loader.sh"

# Strip command prefix if dokku passed it
[[ "${1:-}" == sso:* ]] && shift


SERVICE="$1"

if [[ -z "$SERVICE" ]]; then
  echo "Usage: dokku sso:frontend:apply <service>" >&2
  exit 1
fi

SERVICE_ROOT="$PLUGIN_DATA_ROOT/frontend/$SERVICE"

if ! frontend_service_exists "$SERVICE"; then
  echo "!     Service $SERVICE does not exist" >&2
  exit 1
fi

load_frontend_provider "$SERVICE"

echo "-----> Applying configuration for $SERVICE"

# Validate configuration
echo "       Validating configuration..."
if ! provider_validate_config "$SERVICE"; then
  echo "!     Configuration validation failed" >&2
  exit 1
fi

# Check if app already exists
APP_NAME=$(get_frontend_app_name "$SERVICE")
if [[ -n "$APP_NAME" ]] && "$DOKKU_BIN" apps:exists "$APP_NAME" < /dev/null 2>/dev/null; then
  # App exists — regenerate config and redeploy in-place
  # Re-run provider_create_container which regenerates config + redeploys
  echo "       Updating configuration and redeploying..."
  provider_create_container "$SERVICE"

  # Reload frontend provider (provider_create_container may load directory provider)
  load_frontend_provider "$SERVICE"
else
  # No app yet — full create
  echo "       Creating app..."
  provider_create_container "$SERVICE"

  # Reload frontend provider
  load_frontend_provider "$SERVICE"
fi

# Verify it's working
echo "       Verifying service..."
if provider_verify "$SERVICE"; then
  echo "-----> Configuration applied successfully"
else
  echo "!     Service verification failed" >&2
  exit 1
fi

# Refresh protected apps
if [[ -s "$SERVICE_ROOT/PROTECTED" ]]; then
  echo "-----> Refreshing protected apps"
  while IFS= read -r app; do
    [[ -z "$app" ]] && continue
    echo "       Refreshing $app..."
    provider_protect_app "$SERVICE" "$app" 2>/dev/null || true
  done < "$SERVICE_ROOT/PROTECTED"
fi
